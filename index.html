<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ninja Shadow Strike</title>
  <style>
    /* Enhanced UI Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #fff;
      overflow: hidden;
      user-select: none;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #game-canvas {
      display: block;
      background: #0f0f1a;
      image-rendering: pixelated;
    }

    #hud {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
      z-index: 10;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(0,0,0,0.8);
    }

    #left-hud {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #right-hud {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #level-display, #score-display, #gun-display {
      background: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 12px;
      border: 2px solid #444;
      font-size: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    #coins-display-hud {
      background: linear-gradient(45deg, #ffd700, #ffed4a);
      color: #000;
      padding: 10px 15px;
      border-radius: 12px;
      border: 2px solid #ffd700;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(255,215,0,0.6);
    }

    #health-bar, #invisibility-meter {
      width: 200px;
      height: 25px;
      background: #111;
      border: 3px solid #444;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }

    #health-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #ff2d2d, #ff6b6b);
      transition: width 0.3s ease;
      box-shadow: 0 0 10px #ff2d2d;
    }

    #invis-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #6a5acd, #ba55d3);
      transition: width 0.1s ease;
      box-shadow: 0 0 10px #ba55d3;
    }

    /* Enemy HP Tooltip */
    #enemy-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.95);
      padding: 12px 20px;
      border-radius: 10px;
      border: 2px solid #ff4444;
      font-size: 16px;
      font-weight: bold;
      pointer-events: none;
      z-index: 20;
      display: none;
      box-shadow: 0 0 20px rgba(255,68,68,0.6);
      text-shadow: 0 0 5px #ff0000;
    }

    /* Boss UI */
    #boss-ui {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      padding: 20px 40px;
      border-radius: 20px;
      border: 4px solid #ff4444;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      z-index: 15;
      display: none;
      box-shadow: 0 0 30px rgba(255,68,68,0.8);
    }

    #boss-name {
      color: #ff6666;
      text-shadow: 0 0 10px #ff4444;
      margin-bottom: 10px;
      font-size: 28px;
    }

    #boss-hp-bar {
      width: 400px;
      height: 30px;
      background: #111;
      border: 3px solid #ff4444;
      border-radius: 20px;
      overflow: hidden;
      margin: 10px auto;
      box-shadow: inset 0 0 15px rgba(0,0,0,0.7);
    }

    #boss-hp-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #ff4444, #ff8888);
      transition: width 0.3s ease;
      box-shadow: 0 0 15px #ff4444;
    }

    #shop-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    #shop-menu {
      background: linear-gradient(135deg, #111, #222);
      padding: 40px;
      border-radius: 20px;
      border: 4px solid #ba55d3;
      width: 90%;
      max-width: 700px;
      text-align: center;
      box-shadow: 0 0 40px rgba(186, 85, 211, 0.7);
    }

    #shop-menu h2 {
      margin-bottom: 20px;
      color: #ba55d3;
      font-size: 32px;
      text-shadow: 0 0 15px #ba55d3;
    }

    #coins-display {
      margin-bottom: 25px;
      font-size: 22px;
      color: #ffd700;
      text-shadow: 0 0 10px #ffd700;
    }

    #shop-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .shop-item {
      background: linear-gradient(135deg, #333, #444);
      padding: 20px;
      border-radius: 15px;
      border: 3px solid #555;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .shop-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .shop-item:hover::before {
      left: 100%;
    }

    .shop-item:hover {
      border-color: #ba55d3;
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(186, 85, 211, 0.5);
    }

    .shop-item h3 {
      color: #fff;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .shop-item p {
      font-size: 15px;
      color: #ccc;
      margin-bottom: 12px;
    }

    .shop-item .price {
      color: #ffd700;
      font-weight: bold;
      font-size: 18px;
    }

    .shop-item.bought {
      opacity: 0.7;
      pointer-events: none;
      border-color: #00ff00;
    }

    .shop-item.bought::after {
      content: "‚úì OWNED";
      color: #00ff88;
      font-weight: bold;
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 12px;
      background: rgba(0,255,0,0.2);
      padding: 5px 10px;
      border-radius: 10px;
    }

    #close-shop {
      margin-top: 25px;
      padding: 15px 40px;
      background: linear-gradient(45deg, #ba55d3, #9932cc);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }

    #close-shop:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(186, 85, 211, 0.6);
    }

    .hidden {
      display: none !important;
    }

    #game-over, #win-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.98);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 200;
      text-align: center;
    }

    #game-over h1, #win-screen h1 {
      font-size: 60px;
      margin-bottom: 25px;
      text-shadow: 0 0 20px #ff2d2d;
    }

    #win-screen h1 {
      color: #ffd700;
      text-shadow: 0 0 20px #ffd700;
    }

    #game-over p, #win-screen p {
      font-size: 24px;
      margin: 15px 0;
    }

    #restart-btn, #play-again-btn {
      margin-top: 40px;
      padding: 20px 50px;
      background: linear-gradient(45deg, #ff2d2d, #ff6666);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255,45,45,0.5);
    }

    #play-again-btn {
      background: linear-gradient(45deg, #ffd700, #ffed4a);
      color: #000;
      box-shadow: 0 5px 20px rgba(255,215,0,0.6);
    }

    #restart-btn:hover, #play-again-btn:hover {
      transform: scale(1.1);
    }

    /* Controls overlay */
    #controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game-canvas"></canvas>
    
    <!-- HUD -->
    <div id="hud">
      <div id="left-hud">
        <div id="level-display">Level: <span id="level">1</span></div>
        <div id="health-bar">
          <div id="health-fill"></div>
        </div>
      </div>
      <div id="right-hud">
        <div id="coins-display-hud">üí∞ <span id="coins">0</span></div>
        <div id="gun-display">Weapon: <span id="current-gun">Cardboard Gun</span></div>
        <div id="invisibility-meter">
          <div id="invis-fill"></div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls">
      WASD: Move | Mouse: Aim/Shoot | G: Invisible | P: Shop | Hover: Enemy HP
    </div>

    <!-- Enemy HP Tooltip -->
    <div id="enemy-tooltip">
      <div id="tooltip-name"></div>
      <div id="tooltip-hp"></div>
    </div>

    <!-- Boss UI -->
    <div id="boss-ui">
      <div id="boss-name">üëë JOHN THE 3RD üëë</div>
      <div id="boss-hp-bar">
        <div id="boss-hp-fill"></div>
      </div>
    </div>

    <!-- Shop GUI -->
    <div id="shop-overlay" class="hidden">
      <div id="shop-menu">
        <h2>ü•∑ Ninja Armory ü•∑</h2>
        <p id="coins-display">üí∞ Coins: <span id="coins-shop">0</span></p>
        <div id="shop-items"></div>
        <button id="close-shop">Close (P)</button>
      </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over" class="hidden">
      <h1>üíÄ GAME OVER üíÄ</h1>
      <p>Final Coins: <span id="final-coins">0</span></p>
      <p>Level Reached: <span id="final-level">1</span></p>
      <button id="restart-btn">üîÑ Play Again</button>
    </div>

    <!-- Win Screen -->
    <div id="win-screen" class="hidden">
      <h1>üèÜ NINJA MASTER üèÜ</h1>
      <p>You Defeated John the 3rd!</p>
      <p>Final Coins: <span id="win-coins">0</span></p>
      <button id="play-again-btn">üîÑ Play Again</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Game state
    const game = {
      level: 1,
      coins: 0,
      health: 100,
      maxHealth: 100,
      invisibility: 100, // Start with full invisibility
      maxInvisibility: 100,
      isInvisible: false,
      gameOver: false,
      won: false,
      shopOpen: false,
      enemies: [],
      bullets: [],
      particles: [],
      player: {
        x: canvas.width / 2,
        y: canvas.height / 2,
        radius: 20,
        speed: 5,
        angle: 0
      },
      mouse: { x: 0, y: 0, down: false },
      keys: {},
      currentGun: 'cardboard',
      ownedGuns: ['cardboard'],
      hoveredEnemy: null,
      hasBoss: false,
      spawnInterval: null
    };

    // Gun configurations
    const guns = {
      cardboard: {
        name: "Cardboard Gun",
        damage: 25,
        fireRate: 300,
        bulletSpeed: 12,
        color: '#8B4513',
        particleColor: '#D2691E',
        cost: 0,
        owned: true
      },
      godblaster: {
        name: "God Blaster",
        damage: 100,
        fireRate: 800,
        bulletSpeed: 20,
        color: '#FFD700',
        particleColor: '#FFFF00',
        cost: 500,
        owned: false
      },
      silverflame: {
        name: "Silver Flame",
        damage: 8,
        fireRate: 50,
        bulletSpeed: 8,
        color: '#C0C0C0',
        particleColor: '#FF4500',
        cost: 800,
        owned: false,
        isFlamethrower: true,
        range: 150
      },
      shadowpiercer: {
        name: "Shadow Piercer",
        damage: 60,
        fireRate: 400,
        bulletSpeed: 18,
        color: '#4B0082',
        particleColor: '#9370DB',
        cost: 600,
        owned: false
      },
      plasmacutter: {
        name: "Plasma Cutter",
        damage: 45,
        fireRate: 200,
        bulletSpeed: 15,
        color: '#00CED1',
        particleColor: '#00FFFF',
        cost: 700,
        owned: false
      }
    };

    let enemiesToKill = 0;
    let enemiesKilled = 0;

    // Initialize shop
    function initShop() {
      const shopItems = document.getElementById('shop-items');
      shopItems.innerHTML = '';
      
      Object.keys(guns).forEach(key => {
        if (key === 'cardboard') return;
        
        const gun = guns[key];
        const item = document.createElement('div');
        item.className = 'shop-item';
        if (gun.owned || game.ownedGuns.includes(key)) {
          item.classList.add('bought');
        }
        
        item.innerHTML = `
          <h3>${gun.name}</h3>
          <p>${gun.isFlamethrower ? 'üî• Flamethrower' : 'üî´ Bullet Weapon'}</p>
          <p>Damage: ${gun.damage} | Rate: ${Math.round(1000/gun.fireRate)}/s</p>
          <p class="price">üí∞ ${gun.cost}</p>
        `;
        
        item.addEventListener('click', () => buyGun(key));
        shopItems.appendChild(item);
      });
    }

    function buyGun(gunKey) {
      const gun = guns[gunKey];
      if (game.coins >= gun.cost && !gun.owned && !game.ownedGuns.includes(gunKey)) {
        game.coins -= gun.cost;
        gun.owned = true;
        game.ownedGuns.push(gunKey);
        game.currentGun = gunKey;
        updateHUD();
        initShop();
        playSound('purchase');
      }
    }

    // Sound effects
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      switch(type) {
        case 'shoot':
          oscillator.frequency.value = 800;
          gainNode.gain.value = 0.1;
          oscillator.type = 'square';
          break;
        case 'flame':
          oscillator.frequency.value = 100;
          gainNode.gain.value = 0.15;
          oscillator.type = 'sawtooth';
          break;
        case 'hit':
          oscillator.frequency.value = 300;
          gainNode.gain.value = 0.2;
          oscillator.type = 'triangle';
          break;
        case 'purchase':
          oscillator.frequency.value = 1200;
          gainNode.gain.value = 0.2;
          oscillator.type = 'sine';
          break;
        case 'invis':
          oscillator.frequency.value = 600;
          gainNode.gain.value = 0.15;
          oscillator.type = 'sine';
          break;
        case 'boss':
          oscillator.frequency.value = 150;
          gainNode.gain.value = 0.3;
          oscillator.type = 'sawtooth';
          break;
      }
      
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + (type === 'flame' ? 0.1 : 0.05));
    }

    // Particle system
    class Particle {
      constructor(x, y, color, velocity) {
        this.x = x;
        this.y = y;
        this.color = color;
        this.velocity = velocity;
        this.life = 1;
        this.decay = 0.02;
      }
      
      update() {
        this.x += this.velocity.x;
        this.y += this.velocity.y;
        this.life -= this.decay;
      }
      
      draw() {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
      }
    }

    // Bullet class
    class Bullet {
      constructor(x, y, angle, gun) {
        this.x = x;
        this.y = y;
        this.gun = gun;
        this.radius = gun.isFlamethrower ? 5 : 4;
        this.speed = gun.bulletSpeed;
        this.damage = gun.damage;
        this.range = gun.range || 1000;
        this.distance = 0;
        this.angle = angle;
        this.vx = Math.cos(angle) * this.speed;
        this.vy = Math.sin(angle) * this.speed;
      }
      
      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.distance += this.speed;
        
        if (this.gun.isFlamethrower) {
          for (let i = 0; i < 4; i++) {
            const velocity = {
              x: (Math.random() - 0.5) * 5,
              y: (Math.random() - 0.5) * 5
            };
            game.particles.push(new Particle(this.x, this.y, this.gun.particleColor, velocity));
          }
        }
        
        return this.distance < this.range && 
               this.x > -50 && this.x < canvas.width + 50 && 
               this.y > -50 && this.y < canvas.height + 50;
      }
      
      draw() {
        ctx.fillStyle = this.gun.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
        
        if (this.gun.isFlamethrower) {
          ctx.shadowBlur = 20;
          ctx.shadowColor = this.gun.particleColor;
          ctx.fill();
          ctx.shadowBlur = 0;
        }
      }
    }

    // Enemy class
    class Enemy {
      constructor(isBoss = false) {
        if (isBoss) {
          this.radius = 60;
          this.speed = 0.8;
          this.health = 500;
          this.maxHealth = 500;
          this.isBoss = true;
          playSound('boss');
        } else {
          this.radius = 18 + game.level * 1.5;
          this.speed = 1.8 + game.level * 0.2;
          this.health = 30 + game.level * 10;
          this.maxHealth = this.health;
          this.isBoss = false;
        }
        
        // Spawn from edge
        const side = Math.floor(Math.random() * 4);
        if (side === 0) {
          this.x = Math.random() * canvas.width;
          this.y = -this.radius;
        } else if (side === 1) {
          this.x = canvas.width + this.radius;
          this.y = Math.random() * canvas.height;
        } else if (side === 2) {
          this.x = Math.random() * canvas.width;
          this.y = canvas.height + this.radius;
        } else {
          this.x = -this.radius;
          this.y = Math.random() * canvas.height;
        }
      }
      
      update() {
        const dx = game.player.x - this.x;
        const dy = game.player.y - this.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist > 0) {
          this.x += (dx / dist) * this.speed;
          this.y += (dy / dist) * this.speed;
        }
        
        // Collision with player - 25 DMG (4 hits to kill)
        if (dist < this.radius + game.player.radius && !game.isInvisible) {
          game.health -= 25;
          createExplosion(this.x, this.y, '#ff2d2d');
          playSound('hit');
          updateHUD();
          
          if (game.health <= 0) {
            endGame();
          }
        }
      }
      
      draw() {
        const pulse = Math.sin(Date.now() * 0.01 + this.x) * 0.3 + 1;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.scale(pulse, pulse);
        
        if (this.isBoss) {
          ctx.shadowBlur = 40;
          ctx.shadowColor = '#ff0000';
        } else {
          ctx.shadowBlur = 25;
          ctx.shadowColor = '#ff4444';
        }
        
        const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.radius);
        gradient.addColorStop(0, this.isBoss ? '#ff6666' : '#ff3333');
        gradient.addColorStop(1, this.isBoss ? '#cc0000' : '#990000');
        
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
        ctx.fill();
        
        // Enemy health bar
        if (this.health < this.maxHealth * 0.8) {
          ctx.shadowBlur = 0;
          const barWidth = this.radius * 2 + 8;
          ctx.fillStyle = '#000';
          ctx.fillRect(-barWidth/2, -this.radius - 25, barWidth, 8);
          ctx.fillStyle = '#ff4444';
          ctx.fillRect(-barWidth/2 + 2, -this.radius - 23, (this.health / this.maxHealth) * (barWidth - 4), 4);
        }
        
        ctx.restore();
      }
    }

    // Player movement and shooting
    let lastShot = 0;
    function shoot() {
      const now = Date.now();
      const gun = guns[game.currentGun];
      
      if (now - lastShot > gun.fireRate) {
        lastShot = now;
        const bullet = new Bullet(
          game.player.x + Math.cos(game.player.angle) * 30,
          game.player.y + Math.sin(game.player.angle) * 30,
          game.player.angle,
          gun
        );
        game.bullets.push(bullet);
        
        if (!gun.isFlamethrower) {
          playSound('shoot');
          createMuzzleFlash();
        } else {
          playSound('flame');
        }
      }
    }

    function createMuzzleFlash() {
      for (let i = 0; i < 12; i++) {
        const angle = game.player.angle + (Math.random() - 0.5) * 0.6;
        const speed = 4 + Math.random() * 6;
        const velocity = {
          x: Math.cos(angle) * speed,
          y: Math.sin(angle) * speed
        };
        const flashX = game.player.x + Math.cos(game.player.angle) * 35;
        const flashY = game.player.y + Math.sin(game.player.angle) * 35;
        game.particles.push(new Particle(flashX, flashY, guns[game.currentGun].particleColor, velocity));
      }
    }

    function createExplosion(x, y, color) {
      for (let i = 0; i < 25; i++) {
        const angle = (Math.PI * 2 * i) / 25;
        const speed = 3 + Math.random() * 8;
        const velocity = {
          x: Math.cos(angle) * speed,
          y: Math.sin(angle) * speed
        };
        game.particles.push(new Particle(x, y, color, velocity));
      }
    }

    // Mouse hover detection
    function updateMouseHover() {
      game.hoveredEnemy = null;
      const mouseX = game.mouse.x;
      const mouseY = game.mouse.y;
      
      for (let enemy of game.enemies) {
        const dx = mouseX - enemy.x;
        const dy = mouseY - enemy.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < enemy.radius + 15) {
          game.hoveredEnemy = enemy;
          break;
        }
      }
    }

    // FIXED: Spawn enemies properly
    function spawnWave() {
      // Clear any existing interval
      if (game.spawnInterval) {
        clearInterval(game.spawnInterval);
      }
      
      enemiesToKill = 6 + game.level * 4;
      enemiesKilled = 0;
      
      // Boss spawns on levels 5 and 10
      const spawnBoss = game.level === 5 || game.level === 10;
      if (spawnBoss) {
        enemiesToKill += 1; // Boss counts as one enemy
      }
      
      let bossSpawned = false;
      
      game.spawnInterval = setInterval(() => {
        if (enemiesKilled >= enemiesToKill || game.gameOver || game.won) {
          clearInterval(game.spawnInterval);
          game.spawnInterval = null;
          return;
        }
        
        // Spawn boss first on boss levels
        if (spawnBoss && !bossSpawned && enemiesKilled === 0) {
          game.enemies.push(new Enemy(true));
          game.hasBoss = true;
          document.getElementById('boss-ui').style.display = 'block';
          bossSpawned = true;
          enemiesKilled++; // Count boss as killed for spawn tracking
        } else {
          // Spawn regular enemies
          game.enemies.push(new Enemy(false));
          enemiesKilled++;
        }
      }, 900 - Math.min(game.level * 60, 700));
    }

    // Update HUD
    function updateHUD() {
      document.getElementById('level').textContent = game.level;
      document.getElementById('coins').textContent = game.coins;
      document.getElementById('coins-shop').textContent = game.coins;
      document.getElementById('health-fill').style.width = (game.health / game.maxHealth) * 100 + '%';
      document.getElementById('invis-fill').style.width = (game.invisibility / game.maxInvisibility) * 100 + '%';
      document.getElementById('current-gun').textContent = guns[game.currentGun].name;
      
      // Update tooltip
      if (game.hoveredEnemy) {
        document.getElementById('tooltip-name').textContent = game.hoveredEnemy.isBoss ? 'üëë JOHN THE 3RD üëë' : 'Red Ball Enemy';
        document.getElementById('tooltip-hp').textContent = `HP: ${Math.max(0, Math.floor(game.hoveredEnemy.health))}/${game.hoveredEnemy.maxHealth}`;
        document.getElementById('enemy-tooltip').style.display = 'block';
        document.getElementById('enemy-tooltip').style.left = (game.mouse.x + 20) + 'px';
        document.getElementById('enemy-tooltip').style.top = (game.mouse.y - 40) + 'px';
      } else {
        document.getElementById('enemy-tooltip').style.display = 'none';
      }
      
      // Update boss HP
      if (game.hasBoss) {
        const boss = game.enemies.find(e => e.isBoss);
        if (boss) {
          document.getElementById('boss-hp-fill').style.width = (boss.health / boss.maxHealth) * 100 + '%';
        } else {
          game.hasBoss = false;
          document.getElementById('boss-ui').style.display = 'none';
        }
      }
    }

    // Game loop
    let lastTime = 0;
    function gameLoop(timestamp) {
      if (!lastTime) lastTime = timestamp;
      
      ctx.fillStyle = '#0f0f1a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      if (!game.gameOver && !game.won && !game.shopOpen) {
        // Player movement
        if (game.keys['w'] || game.keys['ArrowUp']) game.player.y -= game.player.speed;
        if (game.keys['s'] || game.keys['ArrowDown']) game.player.y += game.player.speed;
        if (game.keys['a'] || game.keys['ArrowLeft']) game.player.x -= game.player.speed;
        if (game.keys['d'] || game.keys['ArrowRight']) game.player.x += game.player.speed;
        
        game.player.x = Math.max(game.player.radius, Math.min(canvas.width - game.player.radius, game.player.x));
        game.player.y = Math.max(game.player.radius, Math.min(canvas.height - game.player.radius, game.player.y));
        
        // Mouse aiming
        const dx = game.mouse.x - game.player.x;
        const dy = game.mouse.y - game.player.y;
        game.player.angle = Math.atan2(dy, dx);
        
        // Mouse hover
        updateMouseHover();
        
        // FIXED: Invisibility with G key
        if (game.keys['g']) {
          if (game.invisibility > 20 && !game.isInvisible) {
            game.isInvisible = true;
            playSound('invis');
          }
          if (game.isInvisible) {
            game.invisibility -= 0.6;
            if (game.invisibility <= 0) {
              game.isInvisible = false;
              game.invisibility = 0;
            }
          }
        } else if (game.invisibility < game.maxInvisibility) {
          game.invisibility += 0.4;
        }
        
        if (game.invisibility <= 0) game.isInvisible = false;
        
        // Shooting
        if (game.mouse.down) {
          shoot();
        }
        
        // Draw player (ninja)
        ctx.save();
        ctx.translate(game.player.x, game.player.y);
        ctx.rotate(game.player.angle);
        
        if (game.isInvisible) {
          ctx.globalAlpha = 0.25;
        }
        
        // Enhanced ninja
        ctx.fillStyle = '#2a2a2a';
        ctx.beginPath();
        ctx.arc(0, 0, game.player.radius, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#111';
        ctx.fillRect(-game.player.radius * 0.8, -10, game.player.radius * 1.6, 20);
        
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(-8, -4, 4, 0, Math.PI * 2);
        ctx.arc(8, -4, 4, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = guns[game.currentGun].color;
        ctx.fillRect(20, -6, 30, 12);
        
        ctx.restore();
        
        // Update bullets
        game.bullets = game.bullets.filter(bullet => {
          if (!bullet.update()) return false;
          bullet.draw();
          
          for (let i = 0; i < game.enemies.length; i++) {
            const enemy = game.enemies[i];
            const dx = bullet.x - enemy.x;
            const dy = bullet.y - enemy.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist < enemy.radius + bullet.radius) {
              enemy.health -= bullet.damage;
              if (!bullet.gun.isFlamethrower) {
                bullet.distance = bullet.range;
              }
              
              if (enemy.health <= 0) {
                game.enemies.splice(i, 1);
                game.coins += enemy.isBoss ? 100 : (8 + game.level * 3);
                createExplosion(enemy.x, enemy.y, enemy.isBoss ? '#ff6666' : '#ff4500');
                playSound('hit');
                
                if (enemy.isBoss) {
                  game.hasBoss = false;
                  document.getElementById('boss-ui').style.display = 'none';
                }
                
                updateHUD();
                
                // Check level complete
                if (game.enemies.length === 0 && enemiesKilled >= enemiesToKill) {
                  nextLevel();
                }
              }
              break;
            }
          }
          return bullet.distance < bullet.range;
        });
        
        // Update enemies
        game.enemies.forEach(enemy => {
          enemy.update();
          enemy.draw();
        });
        
        // Update particles
        game.particles = game.particles.filter(particle => {
          particle.update();
          particle.draw();
          return particle.life > 0;
        });
        
        updateHUD();
      }
      
      requestAnimationFrame(gameLoop);
    }

    // Level progression
    function nextLevel() {
      game.level++;
      if (game.level > 10) {
        winGame();
      } else {
        game.hasBoss = false;
        document.getElementById('boss-ui').style.display = 'none';
        spawnWave();
      }
    }

    function endGame() {
      game.gameOver = true;
      if (game.spawnInterval) {
        clearInterval(game.spawnInterval);
      }
      document.getElementById('final-coins').textContent = game.coins;
      document.getElementById('final-level').textContent = game.level;
      document.getElementById('game-over').classList.remove('hidden');
    }

    function winGame() {
      game.won = true;
      if (game.spawnInterval) {
        clearInterval(game.spawnInterval);
      }
      document.getElementById('win-coins').textContent = game.coins;
      document.getElementById('win-screen').classList.remove('hidden');
    }

    // Event listeners
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    window.addEventListener('keydown', e => {
      const key = e.key.toLowerCase();
      game.keys[key] = true;
      
      if (key === 'p') {
        if (!game.gameOver && !game.won) {
          game.shopOpen = !game.shopOpen;
          document.getElementById('shop-overlay').classList.toggle('hidden');
          if (game.shopOpen) {
            initShop();
          }
        }
      }
    });

    window.addEventListener('keyup', e => {
      game.keys[e.key.toLowerCase()] = false;
    });

    canvas.addEventListener('mousemove', e => {
      game.mouse.x = e.clientX;
      game.mouse.y = e.clientY;
    });

    canvas.addEventListener('mousedown', () => {
      game.mouse.down = true;
      shoot();
    });

    canvas.addEventListener('mouseup', () => {
      game.mouse.down = false;
    });

    document.getElementById('close-shop').addEventListener('click', () => {
      game.shopOpen = false;
      document.getElementById('shop-overlay').classList.add('hidden');
    });

    document.getElementById('restart-btn').addEventListener('click', () => {
      location.reload();
    });

    document.getElementById('play-again-btn').addEventListener('click', () => {
      location.reload();
    });

    // Start game
    initShop();
    spawnWave();
    updateHUD();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
